!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Keyboard Pong</title>

    <!-- Fireworks.js (for victory explosions) -->
    <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.10.8/dist/index.umd.js"></script>

    <style>
      /* Page layout */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Helvetica, Arial, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f9fafb;
      }

      .wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }

      h1 {
        font-size: 2.25rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        margin: 0;
        text-align: center;
      }

      canvas {
        border: 2px solid #9ca3af;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      p {
        color: #4b5563;
        max-width: 65ch;
        text-align: center;
        margin: 0;
      }

      kbd {
        background: #f1f5f9;
        padding: 2px 4px;
        border-radius: 4px;
        font-family: monospace;
      }

      /* Restart button */
      #restartBtn {
        position: fixed;
        top: 10px;
        left: 10px;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        background: #d1d5db;
        color: #111827;
        font-weight: 600;
        cursor: pointer;
        z-index: 10000;
      }
      #restartBtn:hover {
        background: #9ca3af;
      }

      /* Overlay for end‑game effects */
      #overlay {
        position: fixed;
        inset: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        z-index: 9999;
      }
      #overlay.show {
        display: flex;
      }
      #overlay h2 {
        font-size: 3rem;
        font-weight: 800;
        margin: 0;
        text-transform: uppercase;
        -webkit-text-stroke: 1px #0003;
      }
      .blink {
        animation: blink 1s step-end infinite;
      }
      @keyframes blink {
        50% {
          opacity: 0;
        }
      }

      /* Losing words */
      .loser-word {
        position: fixed;
        top: -40px;
        font-family: Impact, sans-serif;
        font-weight: 700;
        color: #ef4444;
        opacity: 0.9;
        animation: fallWord 4s linear forwards;
        white-space: nowrap;
        pointer-events: none;
      }
      @keyframes fallWord {
        to {
          transform: translateY(110vh) rotate(var(--angle));
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <button id="restartBtn">Restart</button>

    <div class="wrapper">
      <h1>Keyboard Pong</h1>
      <canvas id="gameCanvas"></canvas>
      <p>
        Slide your finger across the keyboard rows (<kbd>1 … =</kbd>,
        <kbd>QWERTY</kbd>, <kbd>ASDF</kbd>, <kbd>ZXCV</kbd>) to move your paddle
        around. First to 10 points wins!
      </p>
    </div>

    <!-- End‑game overlay (hidden until needed) -->
    <div id="overlay"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const overlay = document.getElementById("overlay");
        const restartBtn = document.getElementById("restartBtn");

        // ─────────────────── Resize handling ───────────────────
        function resize() {
          canvas.width = Math.min(window.innerWidth * 0.9, 900);
          canvas.height = Math.min(window.innerHeight * 0.7, 600);
        }
        resize();
        window.addEventListener("resize", resize);

        // ─────────────────── Constants ───────────────────
        const PADDLE_WIDTH = 100;
        const PADDLE_HEIGHT = 12;
        const BALL_RADIUS = 8;
        const PLAYER_MOVE_DURATION = 100; // ms
        const SPEED_MULTIPLIER = 1.2;
        const MAX_SCORE = 10;

        // ─────────────────── Game objects ───────────────────
        const player = {
          x: 0,
          y: 0,
          w: PADDLE_WIDTH,
          h: PADDLE_HEIGHT,
          targetX: null,
          targetY: null,
          startX: null,
          startY: null,
          moveStart: 0,
        };
        const ai = { x: 0, y: 0, w: PADDLE_WIDTH, h: PADDLE_HEIGHT };
        const ball = { x: 0, y: 0, dx: 4, dy: 4 };

        let playerScore = 0;
        let aiScore = 0;
        let gameOver = false;
        let animationFrameId = null;
        let fireworksInstance = null;

        // ─────────────────── Keyboard mapping ───────────────────
        const keyRows = [
          ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "="],
          ["q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\"],
          ["a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'"],
          ["z", "x", "c", "v", "b", "n", "m", ",", ".", "/"],
        ];

        function keyToPosition(key) {
          key = key.toLowerCase();
          let rowIdx = -1,
            colIdx = -1;
          for (let r = 0; r < keyRows.length; r++) {
            const c = keyRows[r].indexOf(key);
            if (c !== -1) {
              rowIdx = r;
              colIdx = c;
              break;
            }
          }
          if (rowIdx === -1) return null;
          const row = keyRows[rowIdx];
          const halfH = canvas.height / 2;
          const rowH = halfH / keyRows.length;
          const y = halfH + rowH * (rowIdx + 0.5);
          const x = ((colIdx + 0.5) / row.length) * canvas.width;
          return { x, y };
        }

        function handleKey(e) {
          if (gameOver) return;
          const pos = keyToPosition(e.key);
          if (!pos) return;
          player.startX = player.x;
          player.startY = player.y;
          player.targetX = pos.x;
          player.targetY = pos.y;
          player.moveStart = performance.now();
        }

        window.addEventListener("keydown", handleKey);

        // ─────────────────── Game loop ───────────────────
        function loop(ts) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Ball
          ball.x += ball.dx;
          ball.y += ball.dy;
          if (ball.x - BALL_RADIUS < 0 || ball.x + BALL_RADIUS > canvas.width) {
            ball.dx *= -1;
          }
          if (ball.y - BALL_RADIUS < 0) {
            playerScore++;
            if (playerScore >= MAX_SCORE) return endGame(true);
            resetBall(4);
          } else if (ball.y + BALL_RADIUS > canvas.height) {
            aiScore++;
            if (aiScore >= MAX_SCORE) return endGame(false);
            resetBall(-4);
          }

          collidePaddle(player);
          collidePaddle(ai);

          // AI paddle
          const diff = ball.x - ai.x;
          ai.x += Math.max(-5, Math.min(5, diff));

          // Player paddle animation
          if (player.targetX !== null) {
            const t = Math.min(1, (ts - player.moveStart) / PLAYER_MOVE_DURATION);
            player.x = player.startX + (player.targetX - player.startX) * t;
            player.y = player.startY + (player.targetY - player.startY) * t;
            if (t === 1) player.targetX = player.targetY = null;
          }

          // Draw
          drawMidline();
          drawPaddle(player, "#10b981");
          drawPaddle(ai, "#3b82f6");
          drawBall();
          drawHUD();

          animationFrameId = requestAnimationFrame(loop);
        }

        // ─────────────────── Helpers ───────────────────
        function resetPositions() {
          player.x = canvas.width / 2;
          player.y = canvas.height - PADDLE_HEIGHT * 2;
          ai.x = canvas.width / 2;
          ai.y = PADDLE_HEIGHT * 2;
          resetBall(4);
        }

        function resetBall(initialDY) {
          ball.x = canvas.width / 2;
          ball.y = canvas.height / 2;
          ball.dx = Math.random() > 0.5 ? 4 : -4;
          ball.dy = initialDY;
        }

        function collidePaddle(p) {
          if (
            ball.x + BALL_RADIUS > p.x - p.w / 2 &&
            ball.x - BALL_RADIUS < p.x + p.w / 2 &&
            ball.y + BALL_RADIUS > p.y - p.h / 2 &&
            ball.y - BALL_RADIUS < p.y + p.h / 2 &&
            (p === player ? ball.dy > 0 : ball.dy < 0)
          ) {
            ball.dy *= -1;
            const offset = (ball.x - p.x) / (p.w / 2);
            ball.dx += offset * 5;
            ball.dx *= SPEED_MULTIPLIER;
            ball.dy *= SPEED_MULTIPLIER;
          }
        }

        function drawPaddle(p, color) {
          ctx.fillStyle = color;
          ctx.fillRect(p.x - p.w / 2, p.y - p.h / 2, p.w, p.h);
        }
        function drawBall() {
          ctx.fillStyle = "#ef4444";
          ctx.beginPath();
          ctx.arc(ball.x, ball.y, BALL_RADIUS, 0, Math.PI * 2);
          ctx.fill();
        }
        function drawMidline() {
          ctx.fillStyle = "#9ca3af";
          ctx.fillRect(0, canvas.height / 2 - 1, canvas.width, 2);
        }
        function drawHUD() {
          ctx.font = "20px monospace";
          ctx.fillStyle = "#111827";
          ctx.fillText(${playerScore}, 20, canvas.height / 2 + 30);
          ctx.fillText(${aiScore}, 20, 30);
        }

        // ─────────────────── End‑game effects ───────────────────
        function endGame(playerWon) {
          gameOver = true;
          cancelAnimationFrame(animationFrameId);
          overlay.classList.add("show");
          overlay.innerHTML = <h2 class="blink" style="color:${
            playerWon ? "#10b981" : "#ef4444"
          }">${playerWon ? "You won!" : "You lost!"}</h2>;

          if (playerWon) {
            // Correct constructor usage for UMD build
            fireworksInstance = new window.Fireworks.default(
              document.body, // container element
              {
                hue: { min: 0, max: 360 },
                rocketsPoint: 50,
                speed: 2,
                acceleration: 1.02,
                particles: 100,
                explosion: 5
              }
            );
            fireworksInstance.start();

            // Stop after 4 seconds
            setTimeout(() => fireworksInstance.stop(), 4000);
          } else {
            // Spawn falling "loser" words for 4 seconds
            const duration = 4000;
            const end = Date.now() + duration;
            const interval = setInterval(() => {
              const div = document.createElement("div");
              div.className = "loser-word";
              div.textContent = "LOSER";
              const size = 14 + Math.random() * 60;
              div.style.fontSize = size + "px";
              const left = Math.random() * window.innerWidth;
              div.style.left = left + "px";
              const angle = (Math.random() * 60 - 30) + "deg";
              div.style.setProperty("--angle", angle);
              div.style.transform = rotate(${angle});
              document.body.appendChild(div);
              setTimeout(() => div.remove(), 4000);
              if (Date.now() > end) clearInterval(interval);
            }, 120);
          }
        }

        // ─────────────────── Restart logic ───────────────────
        function restartGame() {
          // Stop fireworks if running
          if (fireworksInstance) {
            fireworksInstance.stop();
            fireworksInstance = null;
          }
          // Remove leftover loser words
          document.querySelectorAll(".loser-word").forEach((n) => n.remove());

          overlay.classList.remove("show");
          overlay.innerHTML = "";
          playerScore = aiScore = 0;
          gameOver = false;
          resetPositions();
          cancelAnimationFrame(animationFrameId);
          animationFrameId = requestAnimationFrame(loop);
        }

        restartBtn.addEventListener("click", restartGame);

        // ─────────────────── Init ───────────────────
        resetPositions();
        animationFrameId = requestAnimationFrame(loop);

        // Cleanup event listeners on unload
        window.addEventListener("beforeunload", () => {
          window.removeEventListener("keydown", handleKey);
          window.removeEventListener("resize", resize);
        });
      });
    </script>
  </body>
</html>
